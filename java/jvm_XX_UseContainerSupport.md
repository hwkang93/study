# JVM 의 XX:+UseContainerSupport 옵션

자바는 기본적으로 JVM 이라는 가상 머신 위에서 동작을 하게 된다. 그렇기 때문에 자바 애플리케이션을 컨테이너 환경에서 구성한다고 하면, 호스트 OS 위에 컨테이너 위에 JVM 이 올라가게 된다.

이러한 구조 때문에 자바는 기본적으로 컨테이너 환경을 제대로 이해하지 못한다. 자바는 기본적으로 GC 쓰레드 수 및 기본 메모리 제한과 같은 런타임 기본값을 설정하기 위해 운영 체제를 쿼리(cgroup)한다. 
하지만 문제는 결과가 호스트 머신에 대한 정보를 제공하며 컨테이너 구성 및 제한은 포함되지 않는다는 것이다.

## XX:+UseContainerSupport

따라서 자바가 컨테이너 환경을 제대로 이해하도록 ```XX:+UseContainerSupport``` 옵션이 추가되었다.

| 설정(Setting)              | 	영향(Effect)   |
|--------------------------|---------------|
| -XX:-UseContainerSupport | 사용하지 않음       |
| -XX:+UseContainerSupport | 	사용함(Default) |

이를 통해 자바에서 컨테이너에 적합한 최적화가 가능해졌다. 해당 옵션이 활성화되어 있으면 JVM은 컨테이너 환경 내에서 실행 중인지를 감지하고, 그에 따라 기본 설정을 조정하여 성능과 리소스 사용을 최적화한다.

- 메모리 제한: JVM 은 컨테이너의 메모리 제한에 따라 기본값을 조정하여 제한된 환경 보다 효율적으로 메모리를 할당할 수 있음
- CPU 감지: JVM 은 컨테이너 내에서 사용 가능한 CPU를 감지하고, 내부 쓰레드 풀의 크기를 조정하여 CPU 사용률을 최적화함
- 쓰레드 스택 크기: 컨테이너 내의 메모리를 절약하기 위해 기본 쓰레드 스택 크기를 더 작은 값으로 저장할 수 있음
- 기타 등등

컨테이너에서 실행되는 자바 애플리케이션은 보통 자체적으로 실행되므로 메모리를 두고 경쟁할 필요가 없다. 따라서 해당 옵션을 통해 자바 힙에 더 많은 메모리를 할당할 수 있다. 그 경우 메모리는 아래와 같이 설정된다.

| Container memory limit <size> | Maximum Java heap size |
|-------------------------------|------------------------|
| Less than 1 GB                | 50% <size>             |
| 1 GB - 2 GB                   | <size> - 512 MB        |
| Greater than 2 GB             | 75% <size>             |


만약 추가적인 메모리 제한을 필요로 한다면 XX:MaxRAMPercentage 옵션을 사용할 수 있다. 해당 값을 75% 정도가 적당한데, 
이 정도면 다른 프로세스를 위한 RAM 을 남길 수 있을 뿐더러 낭비는 줄어드는 수치라고 한다. 하지만 이는 환경에 맞게 조정이 필요할 수도 있다.

참고로 해당 기능은 자바 10에 도입되어 자바 8u191부터 자바8에 백포트되었으며(자바10에 등장했지만, 자바 8에도 탑재됨), 
이를 통해 컨테이너 환경에서 JVM 이 메모리를 올바르게 구성할 수 있게 되었다.

## Reference

https://mangkyu.tistory.com/297